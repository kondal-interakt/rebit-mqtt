<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RVM QR Scanner - DEBUG MODE</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      margin: 20px;
      background: #1e1e1e;
      color: #00ff00;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #00ff00;
      border-bottom: 2px solid #00ff00;
      padding-bottom: 10px;
    }
    .input-section {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    #scanInput {
      width: 100%;
      padding: 15px;
      font-size: 20px;
      background: #1e1e1e;
      border: 2px solid #00ff00;
      color: #00ff00;
      font-family: 'Courier New', monospace;
    }
    #scanInput:focus {
      outline: none;
      border-color: #00ffff;
      box-shadow: 0 0 10px #00ffff;
    }
    .log-section {
      background: #000;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #00ff00;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #00ff00;
      padding-left: 10px;
    }
    .log-entry.error {
      color: #ff0000;
      border-left-color: #ff0000;
    }
    .log-entry.success {
      color: #00ff00;
      border-left-color: #00ff00;
    }
    .log-entry.info {
      color: #ffff00;
      border-left-color: #ffff00;
    }
    .log-entry.data {
      color: #00ffff;
      border-left-color: #00ffff;
    }
    .config-section {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .status-display {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    }
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 5px;
      margin: 5px;
    }
    button:hover {
      background: #00ffff;
    }
    .timestamp {
      color: #666;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” RVM QR SCANNER - DEBUG MODE</h1>
    
    <div class="config-section">
      <h3>âš™ï¸ Configuration</h3>
      <p><strong>Device ID:</strong> <span id="configDevice">RVM-3101</span></p>
      <p><strong>Backend URL:</strong> <span id="configBackend">https://rebit-api.ceewen.xyz</span></p>
      <p><strong>API Endpoint:</strong> <span id="configEndpoint">/api/rvm/RVM-3101/qr/validate</span></p>
    </div>

    <div class="status-display" id="statusDisplay">
      ğŸ¯ READY - Click input field and scan QR code
    </div>

    <div class="input-section">
      <h3>ğŸ“± QR Scanner Input</h3>
      <input type="text" id="scanInput" autofocus placeholder=">>> FOCUS HERE - Scanner will type here <<<" />
      <p style="color: #ffff00; margin-top: 10px;">
        âš ï¸ Click on the input field above, then scan QR code
      </p>
      <button onclick="testManual()">ğŸ§ª Test with Manual Input</button>
      <button onclick="clearLogs()">ğŸ—‘ï¸ Clear Logs</button>
    </div>

    <div class="log-section" id="logSection">
      <h3>ğŸ“‹ Debug Logs</h3>
      <div id="logs"></div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      deviceId: 'RVM-3101',
      backendUrl: 'https://rebit-api.ceewen.xyz'
    };

    // State
    let scanData = '';
    let lastKeyTime = 0;
    const scanThreshold = 50;

    // Elements
    const scanInput = document.getElementById('scanInput');
    const statusDisplay = document.getElementById('statusDisplay');
    const logsDiv = document.getElementById('logs');

    // Logging function
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
      logsDiv.insertBefore(entry, logsDiv.firstChild);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function clearLogs() {
      logsDiv.innerHTML = '';
      log('Logs cleared', 'info');
    }

    function updateStatus(message, color = '#00ff00') {
      statusDisplay.textContent = message;
      statusDisplay.style.color = color;
    }

    // Keep input focused
    document.addEventListener('click', () => {
      scanInput.focus();
      log('Input focused', 'info');
    });

    scanInput.addEventListener('blur', () => {
      setTimeout(() => {
        scanInput.focus();
        log('Input re-focused automatically', 'info');
      }, 10);
    });

    // Main keyboard event listener
    scanInput.addEventListener('keydown', function(event) {
      const currentTime = new Date().getTime();
      
      log(`âŒ¨ï¸ Key pressed: "${event.key}" (Code: ${event.keyCode})`, 'data');
      
      // Reset if typing too slow (human vs scanner)
      if (currentTime - lastKeyTime > scanThreshold) {
        if (scanData !== '') {
          log(`â±ï¸ Reset scan data (timeout > ${scanThreshold}ms)`, 'info');
        }
        scanData = '';
      }
      
      scanData += event.key;
      lastKeyTime = currentTime;

      // Show current scan data
      updateStatus(`Scanning: ${scanData.replace('Enter', '')}`, '#ffff00');

      // Scanner finishes with Enter
      if (event.key === 'Enter') {
        event.preventDefault();
        
        log('ğŸ¯ ENTER key detected - Processing scan', 'success');
        
        // Clean the data
        const cleanData = scanData.replace('Enter', '').trim();
        
        log(`ğŸ“Š Raw scan data: "${scanData}"`, 'data');
        log(`âœ‚ï¸ Cleaned data: "${cleanData}"`, 'data');
        log(`ğŸ“ Length: ${cleanData.length} characters`, 'data');
        
        // Validate
        if (cleanData.length >= 8 && cleanData.length <= 16) {
          log('âœ… Valid QR code length', 'success');
          processQRCode(cleanData);
        } else {
          log(`âŒ INVALID LENGTH: ${cleanData.length} (expected 8-16)`, 'error');
          updateStatus(`âŒ Invalid QR code length: ${cleanData.length}`, '#ff0000');
          
          setTimeout(() => {
            updateStatus('ğŸ¯ READY - Scan again', '#00ff00');
          }, 3000);
        }
        
        // Reset
        scanData = '';
        scanInput.value = '';
      }
    });

    // Process QR code
    async function processQRCode(sessionCode) {
      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log('ğŸš€ STARTING QR CODE PROCESSING', 'success');
      log(`ğŸ“± Session Code: ${sessionCode}`, 'data');
      
      updateStatus('â³ Validating with backend...', '#ffff00');

      try {
        const url = `${CONFIG.backendUrl}/api/rvm/${CONFIG.deviceId}/qr/validate`;
        
        log(`ğŸŒ Preparing API call`, 'info');
        log(`   URL: ${url}`, 'data');
        log(`   Method: POST`, 'data');
        log(`   Body: { "sessionCode": "${sessionCode}" }`, 'data');

        const requestBody = { sessionCode: sessionCode };
        
        log('ğŸ“¤ Sending request to backend...', 'info');
        
        const startTime = Date.now();
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        const endTime = Date.now();
        
        log(`ğŸ“¥ Response received (${endTime - startTime}ms)`, 'info');
        log(`   Status: ${response.status} ${response.statusText}`, 'data');
        log(`   OK: ${response.ok}`, 'data');

        const responseText = await response.text();
        log(`   Raw response: ${responseText}`, 'data');

        let data;
        try {
          data = JSON.parse(responseText);
          log('   Parsed JSON successfully', 'success');
        } catch (e) {
          log(`âŒ Failed to parse JSON: ${e.message}`, 'error');
          log(`   Response was: ${responseText}`, 'error');
          throw new Error('Invalid JSON response');
        }

        if (response.ok && data.success) {
          log('âœ… VALIDATION SUCCESSFUL!', 'success');
          log(`   Message: ${data.message}`, 'data');
          updateStatus('âœ… WELCOME! Gate opening...', '#00ff00');
          
          setTimeout(() => {
            updateStatus('ğŸšª Gate open - You can deposit items', '#00ffff');
          }, 2000);
          
        } else {
          log('âŒ VALIDATION FAILED', 'error');
          log(`   Success: ${data.success}`, 'data');
          log(`   Error: ${data.error || 'Unknown error'}`, 'error');
          updateStatus('âŒ Invalid QR code', '#ff0000');
          
          setTimeout(() => {
            updateStatus('ğŸ¯ READY - Scan again', '#00ff00');
          }, 3000);
        }

      } catch (error) {
        log('âŒ CONNECTION ERROR', 'error');
        log(`   Error type: ${error.name}`, 'error');
        log(`   Error message: ${error.message}`, 'error');
        log(`   Stack: ${error.stack}`, 'error');
        
        updateStatus('âŒ Cannot connect to backend', '#ff0000');
        
        // Detailed error diagnosis
        if (error.message.includes('Failed to fetch')) {
          log('ğŸ” Diagnosis: Network error - possible causes:', 'info');
          log('   1. Backend server is not running', 'info');
          log('   2. CORS is blocking the request', 'info');
          log('   3. Wrong backend URL', 'info');
          log('   4. SSL certificate issue', 'info');
        }
        
        setTimeout(() => {
          updateStatus('ğŸ¯ READY - Scan again', '#00ff00');
        }, 5000);
      }
      
      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
    }

    // Manual test function
    function testManual() {
      log('ğŸ§ª MANUAL TEST MODE', 'info');
      const testCode = '12345678';
      log(`   Using test code: ${testCode}`, 'data');
      processQRCode(testCode);
    }

    // Initialize
    window.onload = () => {
      scanInput.focus();
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
      log('ğŸš€ QR SCANNER DEBUG MODE INITIALIZED', 'success');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
      log(`ğŸ“± Device: ${CONFIG.deviceId}`, 'data');
      log(`ğŸŒ Backend: ${CONFIG.backendUrl}`, 'data');
      log(`ğŸ¯ Waiting for QR code scan...`, 'info');
      log('', 'info');
      log('âš ï¸ INSTRUCTIONS:', 'info');
      log('   1. Click on the input field', 'info');
      log('   2. Scan QR code with hardware scanner', 'info');
      log('   3. Watch the logs below', 'info');
      log('', 'info');
      
      // Test backend connectivity
      testBackendConnection();
    };

    // Test if backend is reachable
    async function testBackendConnection() {
      log('ğŸ” Testing backend connectivity...', 'info');
      try {
        const response = await fetch(CONFIG.backendUrl, { 
          method: 'HEAD',
          mode: 'no-cors'
        });
        log('âœ… Backend URL is reachable', 'success');
      } catch (error) {
        log('âš ï¸ Cannot reach backend URL', 'error');
        log(`   This might cause issues when scanning`, 'error');
      }
    }
  </script>
</body>
</html>