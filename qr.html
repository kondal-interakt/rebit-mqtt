<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RVM QR Scanner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .container {
      text-align: center;
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 80%;
      max-width: 600px;
    }
    h1 {
      color: #667eea;
      margin-bottom: 20px;
    }
    .scanner-icon {
      font-size: 80px;
      margin: 20px 0;
    }
    .status {
      font-size: 18px;
      color: #666;
      margin: 20px 0;
    }
    .code-display {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 10px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
    }
    /* Input field for scanner - VISIBLE but styled */
    #scanInput {
      width: 100%;
      padding: 15px;
      font-size: 20px;
      border: 3px solid #667eea;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
      background: #f9f9f9;
    }
    #scanInput:focus {
      outline: none;
      border-color: #764ba2;
      background: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Scan Your QR Code</h1>
    <div class="scanner-icon">üì±</div>
    <div class="status" id="status">Ready to scan...</div>
    
    <!-- Input field that captures scanner - MUST BE VISIBLE AND FOCUSED -->
    <input autofocus type="text" id="scanInput" placeholder="Scan QR code here..." />
    
    <div class="code-display" id="codeDisplay">Waiting for QR code...</div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      deviceId: 'RVM-3101',
      backendUrl: 'https://rebit-api.ceewen.xyz'
    };

    let scanData = '';
    let lastKeyTime = 0;
    const scanThreshold = 50; // Scanner types fast (within 50ms between keys)

    const scanInput = document.getElementById('scanInput');
    const statusDiv = document.getElementById('status');
    const codeDisplay = document.getElementById('codeDisplay');

    // Keep input focused
    document.addEventListener('click', () => {
      scanInput.focus();
    });

    // Re-focus if it loses focus
    scanInput.addEventListener('blur', () => {
      setTimeout(() => scanInput.focus(), 10);
    });

    // Listen for keyboard events - EXACTLY like hardware sample
    scanInput.addEventListener('keydown', function(event) {
      const currentTime = new Date().getTime();
      
      // Reset if too much time passed (human typing vs scanner)
      if (currentTime - lastKeyTime > scanThreshold) {
        scanData = '';
      }
      
      // Add the key to scanData (including Enter)
      scanData += event.key;
      lastKeyTime = currentTime;

      // Scanner finishes with Enter key
      if (event.key === 'Enter') {
        event.preventDefault();
        
        // Remove "Enter" from the end
        const cleanData = scanData.replace('Enter', '').trim();
        
        console.log('üì± Scanned Data:', cleanData);
        console.log('   Length:', cleanData.length);
        
        // Validate length (8-16 digits)
        if (cleanData.length >= 8 && cleanData.length <= 16) {
          codeDisplay.textContent = 'Processing: ' + cleanData;
          processQRCode(cleanData);
        } else {
          console.error('‚ùå Invalid length:', cleanData.length);
          statusDiv.textContent = 'Invalid QR code. Please try again.';
          statusDiv.style.color = 'red';
          codeDisplay.textContent = `Error: Invalid code (${cleanData.length} chars)`;
          
          setTimeout(() => {
            statusDiv.textContent = 'Ready to scan...';
            statusDiv.style.color = '#666';
            codeDisplay.textContent = 'Waiting for QR code...';
          }, 3000);
        }
        
        // Reset
        scanData = '';
        scanInput.value = '';
      } else {
        // Show scanning in progress
        codeDisplay.textContent = 'Scanning: ' + scanData.replace('Enter', '');
      }
    });

    // Process the scanned QR code
    async function processQRCode(sessionCode) {
      try {
        statusDiv.textContent = 'Validating...';
        statusDiv.style.color = '#667eea';

        console.log('üì§ Sending to backend:', sessionCode);
        console.log('   URL:', `${CONFIG.backendUrl}/api/rvm/${CONFIG.deviceId}/qr/validate`);

        // Send to backend
        const response = await fetch(
          `${CONFIG.backendUrl}/api/rvm/${CONFIG.deviceId}/qr/validate`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sessionCode: sessionCode
            })
          }
        );

        console.log('üì• Response status:', response.status);
        const data = await response.json();
        console.log('üì• Response data:', data);

        if (data.success) {
          statusDiv.textContent = '‚úÖ Welcome! Gate opening...';
          statusDiv.style.color = 'green';
          codeDisplay.textContent = `Validated: ${sessionCode}`;
          
          console.log('‚úÖ Validation successful');
          
          // Show success for 3 seconds, then reset
          setTimeout(() => {
            statusDiv.textContent = 'You can now deposit items';
            statusDiv.style.color = '#667eea';
            codeDisplay.textContent = 'Gate is open';
          }, 2000);
          
        } else {
          statusDiv.textContent = '‚ùå Invalid QR code';
          statusDiv.style.color = 'red';
          codeDisplay.textContent = 'Validation failed';
          console.error('‚ùå Validation failed:', data);
          
          // Reset after 3 seconds
          setTimeout(() => {
            statusDiv.textContent = 'Ready to scan...';
            statusDiv.style.color = '#666';
            codeDisplay.textContent = 'Waiting for QR code...';
          }, 3000);
        }

      } catch (error) {
        console.error('‚ùå Error:', error);
        statusDiv.textContent = '‚ùå Connection error';
        statusDiv.style.color = 'red';
        codeDisplay.textContent = 'Cannot reach server';
        
        setTimeout(() => {
          statusDiv.textContent = 'Ready to scan...';
          statusDiv.style.color = '#666';
          codeDisplay.textContent = 'Waiting for QR code...';
        }, 3000);
      }
    }

    // Auto-focus on load
    window.onload = () => {
      scanInput.focus();
      console.log('üéØ QR Scanner ready');
      console.log('üì° Backend:', CONFIG.backendUrl);
      console.log('üì± Device:', CONFIG.deviceId);
      console.log('‚ö†Ô∏è  Click on page if scanner not working');
    };
  </script>
</body>
</html>